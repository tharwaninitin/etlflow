<!DOCTYPE html><html><head><title>EtlFlow: Getting started</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Tharwani Nitin" /><meta name="description" content="EtlFlow" /><meta name="og:image" content="/img/poster.png" /><meta name="image" property="og:image" content="/img/poster.png" /><meta name="og:title" content="EtlFlow: Getting started" /><meta name="title" property="og:title" content="EtlFlow: Getting started" /><meta name="og:site_name" content="EtlFlow" /><meta name="og:url" content="https://github.com/tharwaninitin/etljobs" /><meta name="og:type" content="website" /><meta name="og:description" content="EtlFlow" /><link rel="icon" type="image/png" href="/img/favicon.png" /><meta name="twitter:title" content="EtlFlow: Getting started" /><meta name="twitter:image" content="https://tharwaninitin.github.io/etljobs/site//img/poster.png" /><meta name="twitter:description" content="EtlFlow" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/highlight/styles/vs.css" /><link rel="stylesheet" href="/css/pattern-style.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/" class="brand"><div class="brand-wrapper"><span>EtlFlow</span></div></a></li><li><a href="/docs/" class=" active ">Getting started</a></li><li><a href="/css/pattern-style.css" class=""></a></li><li><a href="/docs/steps.html" class="">EtlSteps</a></li></ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/tharwaninitin/etljobs" target="_blank" rel="noopener noreferrer"><i class="fa fa-eye"></i><span>Watchers<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/tharwaninitin/etljobs" target="_blank" rel="noopener noreferrer"><i class="fa fa-star-o"></i><span>Stars<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('EtlFlow EtlFlow');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('EtlFlow EtlFlow');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="tharwaninitin" data-github-repo="etljobs"><div class="content-wrapper"><section><h2 id="getting-started">Getting Started</h2>

<p>Clone this git repo and go inside repo root folder and enter below command (make sure you have sbt and scala installed)</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SBT_OPTS="-Xms512M -Xmx1024M -Xss2M -XX:MaxMetaspaceSize=1024M" sbt -v "project etljobs" console
</code></pre></div></div>

<p><strong>Import core packages</strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import etljobs.etlsteps.SparkReadWriteStep
import etljobs.utils.{CSV,ORC}
</code></pre></div></div>

<p><strong>Define Job input and ouput locations</strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>val canonical_path: String = new java.io.File(".").getCanonicalPath
val job_properties: Map[String,String] = Map(
    "ratings_input_path" -&gt; f"$canonical_path/etljobs/src/test/resources/input/movies/ratings/*",
    "ratings_output_path" -&gt; f"$canonical_path/etljobs/src/test/resources/output/movies/ratings",
    "ratings_output_file_name" -&gt; "ratings.orc"
  )
</code></pre></div></div>

<p><strong>Create spark session</strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import org.apache.spark.sql.SparkSession
org.apache.log4j.Logger.getLogger("org").setLevel(org.apache.log4j.Level.WARN)

lazy val spark: SparkSession  = SparkSession.builder().master("local[*]").getOrCreate()
</code></pre></div></div>

<p><strong>Define ETL Step which will load ratings data with below schema as specified from CSV to ORC</strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import org.apache.spark.sql.SaveMode
case class Rating(user_id:Int, movie_id: Int, rating : Double, timestamp: Long)

val step1 = SparkReadWriteStep[Rating, Rating](
    name                    = "ConvertRatingsCSVtoORC",
    input_location          = Seq(job_properties("ratings_input_path")),
    input_type              = CSV(),
    output_location         = job_properties("ratings_output_path"),
    output_type             = ORC,
    output_save_mode        = SaveMode.Overwrite,
    output_filename         = Some(job_properties("ratings_output_file_name"))
 )(spark)
</code></pre></div></div>

<p><strong>Run this step individually as below</strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> step1.process()
</code></pre></div></div>

<p>Now executing this step will add data in parquet format in path defined in above properties upon completion. This is very basic example for flat load from CSV to ORC but lets say you need to transform csv data in some way for e.g. new column need to be added then we need to create function with below signature:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> import org.apache.spark.sql.{Encoders, Dataset}
 import org.apache.spark.sql.types.DateType
 import org.apache.spark.sql.functions._
 
 case class RatingOutput(user_id:Int, movie_id: Int, rating: Double, timestamp: Long, date: java.sql.Date)
 
 def enrichRatingData()(in : Dataset[Rating]) : Dataset[RatingOutput] = {
     val mapping = Encoders.product[RatingOutput]
 
     val ratings_df = in
         .withColumn("date", from_unixtime(col("timestamp"), "yyyy-MM-dd").cast(DateType))
     
     ratings_df.as[RatingOutput](mapping)
   }
</code></pre></div></div>

<p><strong>Now our step would change to something like this</strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> val step1 = SparkReadWriteStep[Rating, RatingOutput](
     name                    = "ConvertRatingsCSVtoORC",
     input_location          = Seq(job_properties("ratings_input_path")),
     input_type              = CSV(),
     transform_function      = Some(enrichRatingData()),
     output_type             = ORC,
     output_save_mode        = SaveMode.Overwrite,
     output_location         = job_properties("ratings_output_path"),
     output_filename         = Some(job_properties("ratings_output_file_name"))
   )(spark)
 
   step1.process()
</code></pre></div></div>

<p><strong>Lets add another step which will copy this transformed data in Bigquery table. For this step to work correctly <a href="https://cloud.google.com/sdk/install">Google Cloud SDK</a> needs to be installed and configured as in this library upload from local file to Bigquery uses <a href="https://cloud.google.com/bigquery/docs/bq-command-line-tool">bq command</a> which is only recommended to be used in testing environments as in production files should be present on **Google Cloud Storage</strong> when uploading to Bigquery**</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import etljobs.etlsteps.BQLoadStep
import com.google.cloud.bigquery.{BigQuery, BigQueryOptions}
import etljobs.utils.LOCAL

val bq: BigQuery = BigQueryOptions.getDefaultInstance.getService

// Adding two new properties for Bigquery table and Dataset
val job_properties: Map[String,String] = Map(
    "ratings_input_path" -&gt; f"$canonical_path/etljobs/src/test/resources/input/movies/ratings/*",
    "ratings_output_path" -&gt; f"$canonical_path/etljobs/src/test/resources/output/movies/ratings",
    "ratings_output_file_name" -&gt; "ratings.orc",
    "ratings_output_dataset" -&gt; "test",
    "ratings_output_table_name" -&gt; "ratings"
  )

val step2 = BQLoadStep(
    name                = "LoadRatingBQ",
    input_location      = Left(job_properties("ratings_output_path") + "/" + job_properties("ratings_output_file_name")),
    input_type          = ORC,
    input_file_system   = LOCAL,
    output_dataset      = job_properties("ratings_output_dataset"),
    output_table        = job_properties("ratings_output_table_name")
  )(bq)

step2.process()
</code></pre></div></div>

<p><strong>Now we can run this individually like previous step or use ETLJob api to run both of these steps as single job. You can find similar code <a href="modules/examples/src/main/scala/examples">here</a> along with **tests</strong>**</p>

</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/highlight/highlight.pack.js"></script><script>
// For all code blocks, copy the language from the containing div
// to the inner code tag (where hljs expects it to be)
const langPrefix = 'language-';
document.querySelectorAll(`div[class^='${langPrefix}']`).forEach(function(div) {
  div.classList.forEach(function(cssClass) {
    if (cssClass.startsWith(langPrefix)) {
      const lang = cssClass.substring(langPrefix.length);
      div.querySelectorAll('pre code').forEach(function(code) {
        code.classList.add(lang);
      });
    }
  });
});

hljs.configure({languages:['scala','java','bash']});
hljs.initHighlightingOnLoad();
      </script><script>console.info('\x57\x65\x62\x73\x69\x74\x65\x20\x62\x75\x69\x6c\x74\x20\x77\x69\x74\x68\x3a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x5f\x5f\x0a\x20\x20\x20\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x5f\x20\x20\x2f\x20\x2f\x5f\x20\x20\x20\x20\x20\x20\x5f\x5f\x5f\x5f\x20\x5f\x5f\x5f\x20\x20\x28\x5f\x29\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x28\x5f\x29\x20\x2f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x0a\x20\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x60\x5f\x5f\x20\x5c\x2f\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x20\x2f\x20\x5f\x5f\x2f\x20\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x0a\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x5f\x2f\x20\x2f\x20\x2f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x5f\x5f\x2f\x20\x2f\x20\x20\x2f\x20\x2f\x5f\x2f\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x20\x2f\x5f\x2f\x20\x20\x5f\x5f\x28\x5f\x5f\x20\x20\x29\x0a\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2e\x5f\x5f\x5f\x2f\x5c\x5f\x5f\x2f\x20\x20\x20\x20\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x2f\x20\x20\x20\x5c\x5f\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x0a\x0a\x68\x74\x74\x70\x73\x3a\x2f\x2f\x34\x37\x64\x65\x67\x2e\x67\x69\x74\x68\x75\x62\x2e\x69\x6f\x2f\x73\x62\x74\x2d\x6d\x69\x63\x72\x6f\x73\x69\x74\x65\x73')</script><script src="/js/main.js"></script></body></html>